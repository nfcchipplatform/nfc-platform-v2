This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
prisma/
  migrations/
    20251116173333_add_direct_link_fields/
      migration.sql
    20251116175008_add_direct_link_fields_final/
      migration.sql
    20251117113702_add_profile_views/
      migration.sql
    migration_lock.toml
  schema.prisma
public/
  next.svg
  vercel.svg
src/
  actions/
    linkNfcCard.ts
    trackView.ts
    unlinkNfcCard.ts
    updateDirectLink.ts
    updateFavorites.ts
    updateProfile.ts
  app/
    [username]/
      page.tsx
    api/
      auth/
        [...nextauth]/
          route.ts
      favorites/
        route.ts
      profile/
        route.ts
      register/
        route.ts
    card/
      [cardId]/
        page.tsx
    dashboard/
      direct-link/
        page.tsx
      favorites/
        page.tsx
      profile/
        page.tsx
      settings/
        page.tsx
      layout.tsx
      page.tsx
    login/
      page.tsx
    register/
      page.tsx
    favicon.ico
    globals.css
    layout.tsx
    page.tsx
  components/
    DashboardClient.tsx
    DirectLinkInterstitial.tsx
    VCardButton.tsx
  hooks/
    useCurrentUser.ts
  providers/
    AuthSessionProvider.tsx
  types/
    user.ts
types/
  next-auth.d.ts
.eslintrc.json
.gitignore
next.config.mjs
package.json
postcss.config.mjs
README.md
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="prisma/migrations/20251116173333_add_direct_link_fields/migration.sql">
-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "username" TEXT,
    "name" TEXT,
    "email" TEXT,
    "emailVerified" TIMESTAMP(3),
    "hashedPassword" TEXT,
    "image" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "title" TEXT,
    "bio" TEXT,
    "website" TEXT,
    "twitter" TEXT,
    "instagram" TEXT,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Account" (
    "id" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "provider" TEXT NOT NULL,
    "providerAccountId" TEXT NOT NULL,
    "refresh_token" TEXT,
    "access_token" TEXT,
    "expires_at" INTEGER,
    "token_type" TEXT,
    "scope" TEXT,
    "id_token" TEXT,
    "session_state" TEXT,

    CONSTRAINT "Account_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Session" (
    "id" TEXT NOT NULL,
    "sessionToken" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "expires" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Session_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "VerificationToken" (
    "identifier" TEXT NOT NULL,
    "token" TEXT NOT NULL,
    "expires" TIMESTAMP(3) NOT NULL
);

-- CreateTable
CREATE TABLE "Favorite" (
    "id" TEXT NOT NULL,
    "ownerId" TEXT NOT NULL,
    "slotIndex" INTEGER NOT NULL,
    "url" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Favorite_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_username_key" ON "User"("username");

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "Account_provider_providerAccountId_key" ON "Account"("provider", "providerAccountId");

-- CreateIndex
CREATE UNIQUE INDEX "Session_sessionToken_key" ON "Session"("sessionToken");

-- CreateIndex
CREATE UNIQUE INDEX "VerificationToken_token_key" ON "VerificationToken"("token");

-- CreateIndex
CREATE UNIQUE INDEX "VerificationToken_identifier_token_key" ON "VerificationToken"("identifier", "token");

-- CreateIndex
CREATE UNIQUE INDEX "Favorite_ownerId_slotIndex_key" ON "Favorite"("ownerId", "slotIndex");

-- AddForeignKey
ALTER TABLE "Account" ADD CONSTRAINT "Account_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Session" ADD CONSTRAINT "Session_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Favorite" ADD CONSTRAINT "Favorite_ownerId_fkey" FOREIGN KEY ("ownerId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
</file>

<file path="prisma/migrations/20251116175008_add_direct_link_fields_final/migration.sql">
-- AlterTable
ALTER TABLE "User" ADD COLUMN     "directLinkEnabled" BOOLEAN NOT NULL DEFAULT false,
ADD COLUMN     "directLinkUrl" TEXT;
</file>

<file path="prisma/migrations/20251117113702_add_profile_views/migration.sql">
-- CreateTable
CREATE TABLE "ProfileView" (
    "id" TEXT NOT NULL,
    "profileOwnerId" TEXT NOT NULL,
    "viewedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "viewerIp" TEXT,

    CONSTRAINT "ProfileView_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "ProfileView_profileOwnerId_idx" ON "ProfileView"("profileOwnerId");

-- AddForeignKey
ALTER TABLE "ProfileView" ADD CONSTRAINT "ProfileView_profileOwnerId_fkey" FOREIGN KEY ("profileOwnerId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
</file>

<file path="prisma/migrations/migration_lock.toml">
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
</file>

<file path="prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Userãƒ¢ãƒ‡ãƒ« (NextAuth.jsä»•æ§˜ã«æ›´æ–°)
// prisma/schema.prisma

model User {
  id            String    @id @default(cuid())
  username      String?   @unique // 
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  hashedPassword String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  favorites     Favorite[] 

  // --- â†“â†“â†“ ã“ã“ã‹ã‚‰ä¸‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é …ç›®ã‚’è¿½åŠ  â†“â†“â†“ ---
  title         String? // å½¹è·ãƒ»è‚©æ›¸ã
  bio           String? @db.Text // è‡ªå·±ç´¹ä»‹æ–‡
  website       String? // ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURL
  twitter       String? // Twitter URL
  instagram     String? // Instagram URL
  directLinkEnabled Boolean @default(false) // æ©Ÿèƒ½ã®ON/OFF (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯OFF)
  directLinkUrl     String?                 // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®URL

  // --- â†“â†“â†“ ProfileView ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  â†“â†“â†“ ---
  profileViews  ProfileView[] 
  nfcCardId     String?   @unique // ç´ä»˜ã‘ã‚‰ã‚ŒãŸNFCã‚«ãƒ¼ãƒ‰ã®ä¸€æ„ãªID
}

// Accountãƒ¢ãƒ‡ãƒ« (NextAuth.jsã«å¿…é ˆ)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Sessionãƒ¢ãƒ‡ãƒ« (NextAuth.jsã«å¿…é ˆ)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// VerificationTokenãƒ¢ãƒ‡ãƒ« (NextAuth.jsã«å¿…é ˆ)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
// prisma/schema.prisma ã®æœ«å°¾ã«è¿½åŠ 

model Favorite {
  id        String   @id @default(cuid())
  ownerId   String   // ã“ã®ãŠæ°—ã«å…¥ã‚Šã®æ‰€æœ‰è€…ã®ID
  slotIndex Int      // ã‚¹ãƒ­ãƒƒãƒˆã®ç•ªå· (0ã‹ã‚‰4)
  url       String   // ç™»éŒ²ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL or ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([ownerId, slotIndex]) // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åŒã˜ã‚¹ãƒ­ãƒƒãƒˆç•ªå·ã‚’ç™»éŒ²ã§ããªã„
}

// --- â†“â†“â†“ æ–°ã—ãè¿½åŠ ã™ã‚‹ ProfileView ãƒ¢ãƒ‡ãƒ« â†“â†“â†“
model ProfileView {
  id        String   @id @default(cuid())
  // é–²è¦§ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
  profileOwnerId String 
  // é–²è¦§æ—¥æ™‚
  viewedAt  DateTime @default(now())
  // é–²è¦§ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨˜éŒ² (ç°¡æ˜“çš„ãªé‡è¤‡é˜²æ­¢ç”¨)
  viewerIp  String?  

  // é–²è¦§ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  profileOwner User @relation(fields: [profileOwnerId], references: [id], onDelete: Cascade)

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦æ¤œç´¢æ€§èƒ½ã‚’å‘ä¸Š
  @@index([profileOwnerId]) 
}
</file>

<file path="src/actions/linkNfcCard.ts">
// src/actions/linkNfcCard.ts

"use server";

import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export async function linkNfcCard(userId: string, cardId: string) {
  console.log("ğŸš€ NFC Link Action å‘¼ã³å‡ºã—é–‹å§‹"); // â–¼â–¼â–¼ è¿½åŠ 
  console.log(`- ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}, ã‚«ãƒ¼ãƒ‰ID: ${cardId}`); // â–¼â–¼â–¼ è¿½åŠ 
  try {
    // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ãã®ã‚«ãƒ¼ãƒ‰IDã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèª
    const existingCardUser = await prisma.user.findUnique({
      where: { nfcCardId: cardId },
    });

    if (existingCardUser) {
      console.log("ğŸš« ã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™"); // â–¼â–¼â–¼ è¿½åŠ 
      return { success: false, error: "ã“ã®NFCã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚«ãƒ¼ãƒ‰IDã‚’ã‚»ãƒƒãƒˆã—ã¦æ›´æ–°
    await prisma.user.update({
      where: { id: userId },
      data: { nfcCardId: cardId },
    });
    
    console.log("ğŸ‰ NFCã‚«ãƒ¼ãƒ‰ç´ä»˜ã‘æˆåŠŸï¼"); // â–¼â–¼â–¼ è¿½åŠ 

    return { success: true };

  } catch (error) {
    console.error("âŒ NFC_LINK_ERROR", error); // â–¼â–¼â–¼ ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚‚ãƒ­ã‚°ã‚’å‡ºã™
    return { success: false, error: "NFCã‚«ãƒ¼ãƒ‰ã®ç´ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}
</file>

<file path="src/actions/trackView.ts">
"use server";

import { PrismaClient } from "@prisma/client";
import { headers } from "next/headers";

const prisma = new PrismaClient();

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã—ã¾ã™ã€‚
 * @param profileOwnerId é–²è¦§ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
 */
export async function trackProfileView(profileOwnerId: string) {
  try {
    // é–²è¦§ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
    // NOTE: å®Ÿéš›ã®é‹ç”¨ç’°å¢ƒã§ã¯ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚„ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šã«å¿œã˜ã¦
    // 'x-forwarded-for' ãªã©ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    const forwardedFor = headers().get('x-forwarded-for');
    // x-forwarded-for ãŒã‚ã‚‹å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æœ€åˆã®IPã‚’ã€ãªã‘ã‚Œã° x-real-ip ã‚’ã€ã©ã¡ã‚‰ã‚‚ãªã‘ã‚Œã° 'Unknown' ã‚’ä½¿ç”¨
    const viewerIp = forwardedFor ? forwardedFor.split(',')[0].trim() : headers().get('x-real-ip') || 'Unknown';
    
    // éå»1æ™‚é–“ä»¥å†…ã«åŒã˜IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®é–²è¦§è¨˜éŒ²ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“çš„ãªé‡è¤‡é˜²æ­¢ï¼‰
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000); 

    const recentView = await prisma.profileView.findFirst({
        where: {
            profileOwnerId,
            viewerIp,
            viewedAt: {
                gte: oneHourAgo, // 1æ™‚é–“å‰ã‚ˆã‚Šã‚‚æ–°ã—ã„ï¼ˆgteï¼‰è¨˜éŒ²ã‚’æ¢ã™
            },
        },
    });

    if (recentView) {
        // éå»1æ™‚é–“ä»¥å†…ã«é–²è¦§æ¸ˆã¿ã®ãŸã‚ã€è¨˜éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—
        return { success: true, message: "View skipped due to recent visit from same IP." };
    }

    // æ–°ã—ã„é–²è¦§è¨˜éŒ²ã‚’ä½œæˆ
    await prisma.profileView.create({
      data: {
        profileOwnerId,
        viewerIp, // å–å¾—ã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨˜éŒ²
      },
    });

    return { success: true };
  } catch (error) {
    console.error("TRACK_VIEW_ERROR", error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºè‡ªä½“ã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
    return { success: false, error: "Failed to track view." };
  }
}

/**
 * ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·é–²è¦§æ•°ã‚’å–å¾—ã—ã¾ã™ã€‚
 * @param profileOwnerId ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
export async function getProfileViewCount(profileOwnerId: string) {
    try {
        const count = await prisma.profileView.count({
            where: {
                profileOwnerId: profileOwnerId,
            },
        });
        return { success: true, count };
    } catch (error) {
        console.error("GET_VIEW_COUNT_ERROR", error);
        return { success: false, count: 0, error: "Failed to fetch view count." };
    }
}
</file>

<file path="src/actions/unlinkNfcCard.ts">
// src/actions/unlinkNfcCard.ts

"use server";

import { getServerSession } from "next-auth";
// â–¼â–¼â–¼ ã“ã®2è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
import { Prisma, PrismaClient } from "@prisma/client";
import { authOptions } from "@/app/api/auth/[...nextauth]/route";
import { revalidatePath } from "next/cache";

const prisma = new PrismaClient();

export async function unlinkNfcCard() {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return { success: false, error: "èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" };
    }

    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    // æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€Prismaã®å‹ã‚’ä½¿ã£ã¦æ˜ç¤ºçš„ã«å®šç¾©
    const dataToUpdate: Prisma.UserUpdateInput = {
      nfcCardId: null,
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®nfcCardIdã‚’nullã«è¨­å®šã—ã¦æ›´æ–°
    await prisma.user.update({
      where: { id: session.user.id },
      data: dataToUpdate,
    });
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    // é–¢é€£ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    revalidatePath('/dashboard/settings');

    return { success: true };

  } catch (error) {
    console.error("NFC_UNLINK_ERROR", error);
    return { success: false, error: "NFCã‚«ãƒ¼ãƒ‰ã®ç´ä»˜ã‘è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}
</file>

<file path="src/actions/updateDirectLink.ts">
// src/actions/updateDirectLink.ts (å®Œå…¨ãªæœ€çµ‚ç‰ˆ)

"use server";

import { getServerSession } from "next-auth";
import { PrismaClient } from "@prisma/client";
import { authOptions } from "@/app/api/auth/[...nextauth]/route";

const prisma = new PrismaClient();

// -----------------------------------------------------------
// getDirectLinkSettings é–¢æ•°
// -----------------------------------------------------------
export async function getDirectLinkSettings() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return { error: "èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“" };
  }
  try {
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: { directLinkEnabled: true, directLinkUrl: true },
    });
    return { success: true, settings: user };
  } catch (error) {
    return { error: "è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}

// -----------------------------------------------------------
// updateDirectLink é–¢æ•°
// -----------------------------------------------------------
export async function updateDirectLink(enabled: boolean, url: string) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return { error: "èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“" };
  }
  try {
    const dataToUpdate = {
      directLinkEnabled: enabled,
      directLinkUrl: enabled ? url : null,
    };

    await prisma.user.update({
      where: { id: session.user.id },
      data: dataToUpdate,
    });

    return { success: true };
  } catch (error) {
    console.error("UPDATE_DIRECTLINK_ERROR", error);
    return { success: false, error: "è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}
</file>

<file path="src/actions/updateFavorites.ts">
// src/actions/updateFavorites.ts

"use server";

import { getServerSession } from "next-auth";
import { PrismaClient } from "@prisma/client";
import { authOptions } from "@/app/api/auth/[...nextauth]/route";

const prisma = new PrismaClient();

export async function updateFavorites(slots: string[]) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
    const ownerId = session.user.id;

    await prisma.$transaction(async (tx) => {
      await tx.favorite.deleteMany({ where: { ownerId } });
      const newFavorites = slots
        .map((url, index) => ({ ownerId, slotIndex: index, url }))
        .filter(fav => fav.url.trim() !== '');
      if (newFavorites.length > 0) {
        await tx.favorite.createMany({ data: newFavorites });
      }
    });
    return { success: true };
  } catch (error) {
    return { success: false, error: "è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}
</file>

<file path="src/actions/updateProfile.ts">
"use server";

import { getServerSession } from "next-auth";
import { PrismaClient } from "@prisma/client";
import { authOptions } from "../app/api/auth/[...nextauth]/route";
import { revalidatePath } from "next/cache";

const prisma = new PrismaClient();

interface ProfileData {
  name?: string;
  title?: string;
  bio?: string;
  website?: string;
  twitter?: string;
  instagram?: string;
  image?: string | null;
}

export async function updateProfile(data: ProfileData) {
  try {
    const session = await getServerSession(authOptions);

    if (!session?.user?.id) {
      throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }

    // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹
    const updatedUser = await prisma.user.update({
      where: { id: session.user.id },
      data: data,
    });
    console.log("ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã‚³ãƒãƒ³ãƒ‰ã¯æˆåŠŸã—ã¾ã—ãŸ");

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒæœ€çµ‚æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã§ã™ â–¼â–¼â–¼
    // 2. æ›´æ–°ç›´å¾Œã«ã€æ”¹ã‚ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    const userFromDbAfterUpdate = await prisma.user.findUnique({
      where: { id: session.user.id },
    });
    
    // 3. ãã®ã€ŒDBã‹ã‚‰å–å¾—ã—ãŸã°ã‹ã‚Šã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã€ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«å‡ºåŠ›ã™ã‚‹
    console.log("ğŸ“ æ›´æ–°ç›´å¾Œã®DBãƒ‡ãƒ¼ã‚¿:", userFromDbAfterUpdate);
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    revalidatePath('/dashboard/profile');
    if (updatedUser.username) {
        revalidatePath(`/${updatedUser.username}`);
    }

    // ãƒ•ãƒ­ãƒ³ãƒˆã«ã¯ã€æœ€åˆã«updateã—ãŸçµæœã‚’è¿”ã™
    return { success: true, user: updatedUser };

  } catch (error) {
    console.error("âŒ PROFILE_UPDATE_ERROR:", error);
    return { success: false, error: "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" };
  }
}
</file>

<file path="src/app/[username]/page.tsx">
// src/app/[username]/page.tsx

import { PrismaClient } from "@prisma/client";
import { trackProfileView } from "@/actions/trackView";
import VCardButton from "@/components/VCardButton";
import DirectLinkInterstitial from "@/components/DirectLinkInterstitial";

const prisma = new PrismaClient();

interface UserProfilePageProps {
  params: {
    username: string;
  };
  // â–¼â–¼â–¼ searchParamsã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«propsã‚’è¿½åŠ  â–¼â–¼â–¼
  searchParams: { [key: string]: string | string[] | undefined };
}

export default async function UserProfilePage({ params, searchParams }: UserProfilePageProps) { // searchParamsã‚’è¿½åŠ 
  const { username } = params;

  const user = await prisma.user.findUnique({
    where: {
      username: decodeURIComponent(username),
    },
  });

  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <h1 className="text-2xl font-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
      </div>
    );
  }
  
  // â–¼â–¼â–¼ ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªãƒ³ã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
  // URLã« "from=interstitial" ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªãƒ³ã‚¯ã‚’è©•ä¾¡ã™ã‚‹
  const fromInterstitial = searchParams.from === 'interstitial';

  if (user.directLinkEnabled && user.directLinkUrl && !fromInterstitial) {
    return (
      <DirectLinkInterstitial 
        redirectUrl={user.directLinkUrl}
        profileUrl={`/${user.username}`}
      />
    );
  }
  // â–²â–²â–² â–²â–²â–² â–²â–²â–²

  // é€šå¸¸ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
  await trackProfileView(user.id);

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-50">
      <div className="w-full max-w-sm bg-white border border-gray-200 rounded-lg shadow-md p-8">
        <div className="flex flex-col items-center">
          {user.image ? (
            <img className="w-24 h-24 mb-3 rounded-full shadow-lg object-cover" src={user.image} alt={user.name || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ'} />
          ) : (
            <div className="w-24 h-24 mb-3 rounded-full shadow-lg bg-gray-200" />
          )}
          <h5 className="mb-1 text-xl font-medium text-gray-900">{user.name}</h5>
          <span className="text-sm text-gray-500">{user.title}</span>
          <p className="text-sm text-center text-gray-600 my-4">{user.bio}</p>
          
          <div className="flex mt-4 space-x-3 md:mt-6">
            <VCardButton user={{ name: user.name, title: user.title, email: user.email, website: user.website }} />
          </div>
          
          <div className="flex mt-4 space-x-3 md:mt-6">
            {user.website && <a href={user.website} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">Website</a>}
            {user.twitter && <a href={user.twitter} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">Twitter</a>}
            {user.instagram && <a href={user.instagram} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">Instagram</a>}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/api/auth/[...nextauth]/route.ts">
// src/app/api/auth/[...nextauth]/route.ts

import NextAuth, { AuthOptions } from "next-auth";
import { PrismaAdapter } from "@auth/prisma-adapter";
import { PrismaClient } from "@prisma/client";
import CredentialsProvider from "next-auth/providers/credentials";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

export const authOptions: AuthOptions = {
  adapter: PrismaAdapter(prisma),

  providers: [
    CredentialsProvider({
      name: "credentials",
      credentials: {
        email: { label: "Email", type: "text" },
        password: { label: "Password", type: "password" },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          throw new Error("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™");
        }
        const user = await prisma.user.findUnique({
          where: { email: credentials.email },
        });
        if (!user || !user.hashedPassword) {
          throw new Error("ç„¡åŠ¹ãªèªè¨¼æƒ…å ±ã§ã™");
        }
        const isCorrectPassword = await bcrypt.compare(
          credentials.password,
          user.hashedPassword
        );
        if (!isCorrectPassword) {
          throw new Error("ç„¡åŠ¹ãªèªè¨¼æƒ…å ±ã§ã™");
        }
        return user;
      },
    }),
  ],

  callbacks: {
    // 1. ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ ¼ç´ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°æ™‚ã«ã‚‚æœ€æ–°åŒ–ã™ã‚‹
    async jwt({ token, user, trigger, session }) {
      // ãƒ­ã‚°ã‚¤ãƒ³æ™‚
      if (user) {
        token.sub = user.id; // subã¯æ¨™æº–çš„ãªJWTã®ä¸»é¡Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      }
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°æ™‚ (useSessionã®update()ãŒå‘¼ã°ã‚ŒãŸæ™‚)
      // ã“ã‚Œã«ã‚ˆã‚Šã€NFCè§£é™¤å¾Œãªã©ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹
      if (trigger === "update" && token.sub) {
        // DBã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸Šæ›¸ã
        const dbUser = await prisma.user.findUnique({ where: { id: token.sub as string } });
        if (dbUser) {
          token.nfcCardId = dbUser.nfcCardId;
        }
      }

      return token;
    },
    
    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦æ±‚ã•ã‚Œã‚‹ãŸã³ã«ã€DBã‹ã‚‰æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹
    async session({ session, token }) {
      if (session.user && token.sub) {
        const dbUser = await prisma.user.findUnique({
          where: { id: token.sub },
        });

        if (dbUser) {
          session.user.id = dbUser.id;
          session.user.name = dbUser.name;
          session.user.email = dbUser.email;
          session.user.image = dbUser.image;
          (session.user as any).username = dbUser.username;
          (session.user as any).title = dbUser.title;
          (session.user as any).bio = dbUser.bio;
          (session.user as any).website = dbUser.website;
          (session.user as any).twitter = dbUser.twitter;
          (session.user as any).instagram = dbUser.instagram;
          (session.user as any).nfcCardId = dbUser.nfcCardId;
        }
      }
      return session;
    },
  },
  
  session: { 
    strategy: "jwt" 
  },
  
  secret: process.env.NEXTAUTH_SECRET,

  debug: process.env.NODE_ENV === "development",
};

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
</file>

<file path="src/app/api/favorites/route.ts">
// src/app/api/favorites/route.ts

import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "../auth/[...nextauth]/route";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

// â†“â†“â†“ ã“ã®å‹å®šç¾©ã‚’è¿½åŠ  â†“â†“â†“
interface FavoriteProfile {
    username: string | null;
    name: string | null;
    image: string | null;
}

// GETãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼‰ã‚’å‡¦ç†ã™ã‚‹
export async function GET(request: Request) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return new NextResponse("Unauthorized", { status: 401 });
    }

    // 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šã‚¹ãƒ­ãƒƒãƒˆè¨­å®šã‚’å–å¾—
    const favorites = await prisma.favorite.findMany({
      where: { ownerId: session.user.id },
      orderBy: { slotIndex: 'asc' },
    });

    // 2. 5ä»¶åˆ†ã®ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—ã‚’ä½œæˆ
    const slots = Array(5).fill('');
    favorites.forEach(fav => {
      if (fav.slotIndex >= 0 && fav.slotIndex < 5) {
        slots[fav.slotIndex] = fav.url;
      }
    });

    // 3. ã‚¹ãƒ­ãƒƒãƒˆã®ä¸­ã‹ã‚‰usernameã ã‘ã‚’æŠ½å‡º
    const usernames = slots.filter(slot => slot && !slot.startsWith('http'));

    // 4. usernameã‚’ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    let profiles: FavoriteProfile[] = [];
    if (usernames.length > 0) {
      profiles = await prisma.user.findMany({
        where: { username: { in: usernames } },
        select: { username: true, name: true, image: true },
      });
    }

    // 5. æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™
    return NextResponse.json({ slots, profiles });

  } catch (error) {
    console.error("GET_FAVORITES_ERROR", error);
    return new NextResponse("Internal Server Error", { status: 500 });
  }
}
</file>

<file path="src/app/api/profile/route.ts">
// src/app/api/profile/route.ts

import { NextResponse } from "next/server";
import { PrismaClient } from "@prisma/client";
import { getServerSession } from "next-auth"; 
import { authOptions } from "../auth/[...nextauth]/route";

const prisma = new PrismaClient();

// PATCHãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã‚’æ›´æ–°ã™ã‚‹ï¼‰ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã€ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å½¹å‰²ã‚’è­²ã£ãŸãŸã‚ã€ç›´æ¥ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
// å°†æ¥çš„ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰ã®è¤‡é›‘ãªæ›´æ–°å‡¦ç†ãŒå¿…è¦ã«ãªã£ãŸå ´åˆã®ãŸã‚ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚
export async function PATCH(request: Request) {
  try {
    // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    const session = await getServerSession(authOptions);

    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!session?.user?.id) {
      return new NextResponse("Unauthorized", { status: 401 });
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‹ã‚‰æ›´æ–°ã—ãŸã„ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    const body = await request.json();
    const { name, title, bio, website, twitter, instagram } = body;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
    const updatedUser = await prisma.user.update({
      where: {
        id: session.user.id, // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’æŒ‡å®š
      },
      data: {
        name,
        title,
        bio,
        website,
        twitter,
        instagram,
      },
    });

    // æˆåŠŸã—ãŸã‚‰æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
    return NextResponse.json(updatedUser);

  } catch (error) {
    console.error("PROFILE_UPDATE_ERROR", error);
    return new NextResponse("Internal Server Error", { status: 500 });
  }
}
</file>

<file path="src/app/api/register/route.ts">
// src/app/api/register/route.ts (æœ€çµ‚ç‰ˆ)

import { NextResponse } from "next/server";
import bcrypt from "bcryptjs";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { email, name, password, username } = body;

    // å¿…é ˆé …ç›®ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!email || !password || !username) {
      return new NextResponse("Email, password, and username are required", { status: 400 });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœ‰åŠ¹ãªå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯ (åŠè§’è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿)
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      return new NextResponse("Username must be alphanumeric", { status: 400 });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const existingUserByUsername = await prisma.user.findUnique({
      where: { username },
    });
    if (existingUserByUsername) {
      return new NextResponse("Username already taken", { status: 409 });
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const existingUserByEmail = await prisma.user.findUnique({
      where: { email },
    });
    if (existingUserByEmail) {
      return new NextResponse("Email already taken", { status: 409 });
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
    const hashedPassword = await bcrypt.hash(password, 12);

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
    const user = await prisma.user.create({
      data: {
        name,
        email,
        hashedPassword,
        username,
      },
    });

    return NextResponse.json(user);

  } catch (error) {
    console.error("REGISTRATION_ERROR", error);
    return new NextResponse("Internal Server Error", { status: 500 });
  }
}
</file>

<file path="src/app/card/[cardId]/page.tsx">
// src/app/card/[cardId]/page.tsx

import { PrismaClient } from "@prisma/client";
import { getServerSession } from "next-auth";
// â–¼â–¼â–¼ ã“ã®è¡Œã‚’ä¿®æ­£ã—ã¾ã™ â–¼â–¼â–¼
import { authOptions } from "@/app/api/auth/[...nextauth]/route";
// â–²â–²â–² â–²â–²â–² â–²â–²â–²
import { redirect } from "next/navigation";
import Link from "next/link";

const prisma = new PrismaClient();

interface CardPageProps {
  params: {
    cardId: string;
  };
}

export default async function CardPage({ params }: CardPageProps) {
  const { cardId } = params;

  // 1. ã“ã®ã‚«ãƒ¼ãƒ‰IDã«ç´ä»˜ã„ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã™
  const userWithCard = await prisma.user.findUnique({
    where: { nfcCardId: cardId },
  });

  if (userWithCard) {
    // --- ã‚«ãƒ¼ãƒ‰ãŒç™»éŒ²æ¸ˆã¿ã®å ´åˆã®å‡¦ç† ---

    // 2. ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯nullï¼‰
    const session = await getServerSession(authOptions);

    if (session?.user?.id === userWithCard.id) {
      // 3. è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ã‹ã¤ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ
      // -> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      redirect('/dashboard');
    } else {
      // 4. ä»–äººã®ã‚«ãƒ¼ãƒ‰ã€ã¾ãŸã¯è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã ãŒæœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
      // -> ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      redirect(`/${userWithCard.username}`);
    }

  } else {
    // --- ã‚«ãƒ¼ãƒ‰ãŒæœªç™»éŒ²ã®å ´åˆã®å‡¦ç† ---
    
    // 5. ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ä»˜ã‘ã‚‹ãŸã‚ã®é¸æŠç”»é¢ã‚’è¡¨ç¤º
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="p-8 bg-white rounded-lg shadow-md w-full max-w-md text-center">
          <h1 className="text-2xl font-bold mb-2">NFCã‚«ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–</h1>
          <p className="text-gray-600 mb-6">
            ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ä»˜ã‘ã¾ã™ã€‚
          </p>
          <div className="space-y-4">
            <Link 
              // æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ã«ã€ã‚«ãƒ¼ãƒ‰IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
              href={`/register?cardId=${cardId}`}
              className="block w-full px-4 py-3 text-lg font-semibold text-center text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
            >
              æ–°è¦ç™»éŒ²ã—ã¦ç´ä»˜ã‘ã‚‹
            </Link>
            <Link 
              // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã€ã‚«ãƒ¼ãƒ‰IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
              href={`/login?cardId=${cardId}`}
              className="block w-full px-4 py-3 text-lg font-semibold text-center text-gray-800 bg-gray-200 rounded-lg hover:bg-gray-300"
            >
              æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç´ä»˜ã‘ã‚‹
            </Link>
          </div>
        </div>
      </div>
    );
  }
}
</file>

<file path="src/app/dashboard/direct-link/page.tsx">
// src/app/dashboard/direct-link/page.tsx
"use client";
import { useState, useEffect } from "react";
import { getDirectLinkSettings, updateDirectLink } from "@/actions/updateDirectLink";

export default function DirectLinkPage() {
  const [enabled, setEnabled] = useState(false);
  const [url, setUrl] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  useEffect(() => {
    getDirectLinkSettings().then(res => {
      if (res.success && res.settings) {
        setEnabled(res.settings.directLinkEnabled);
        setUrl(res.settings.directLinkUrl || "");
      }
    });
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError("");
    setSuccess("");
    
    // enabledãŒfalseã®å ´åˆã¯ã€urlã«ç©ºæ–‡å­—åˆ—ã‚’æ¸¡ã™
    const result = await updateDirectLink(enabled, url); 
    
    if (result.success) {
      setSuccess("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    } else {
      setError(result.error || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
    setIsLoading(false);
  };

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6 text-gray-800">ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªãƒ³ã‚¯è¨­å®š</h1>
      <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md max-w-2xl">
        {error && <p className="mb-4 text-red-500">{error}</p>}
        {success && <p className="mb-4 text-green-500">{success}</p>}
        <div className="flex items-center justify-between mb-4">
          <label htmlFor="enabled" className="text-lg font-medium text-gray-700">æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
          <button type="button" onClick={() => setEnabled(!enabled)} className={`${enabled ? 'bg-indigo-600' : 'bg-gray-200'} relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out`}>
            <span className={`${enabled ? 'translate-x-5' : 'translate-x-0'} inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out`} />
          </button>
        </div>
        {enabled && (
          <div>
            <label htmlFor="url" className="block text-sm font-medium text-gray-700">ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆURL</label>
            <input type="url" id="url" value={url} onChange={(e) => setUrl(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://..." />
          </div>
        )}
        <div className="mt-6">
          <button type="submit" disabled={isLoading} className="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
            {isLoading ? "ä¿å­˜ä¸­..." : "ä¿å­˜ã™ã‚‹"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="src/app/dashboard/favorites/page.tsx">
// src/app/dashboard/favorites/page.tsx (æœ¬å½“ã«æœ€çµ‚ç¢ºå®šç‰ˆ)

"use client";

import { useState, useEffect } from "react";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";

// updateFavoritesã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { updateFavorites } from "@/actions/updateFavorites";

export default function FavoritesPage() {
  const { status } = useSession();
  const router = useRouter();

  const [slots, setSlots] = useState<string[]>(['', '', '', '', '']);
  const [isLoading, setIsLoading] = useState(false);
  const [isFetching, setIsFetching] = useState(true);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€APIã‹ã‚‰ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã™ã‚‹
  useEffect(() => {
    const fetchFavorites = async () => {
      setIsFetching(true);
      try {
        const response = await fetch('/api/favorites'); // â˜…â˜…â˜… APIãƒ«ãƒ¼ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ â˜…â˜…â˜…
        if (!response.ok) {
          throw new Error("Failed to fetch favorites");
        }
        const data = await response.json();
        if (data.slots) {
          setSlots(data.slots);
        }
      } catch (err) {
        setError("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      } finally {
        setIsFetching(false);
      }
    };
    
    if (status === "authenticated") {
      fetchFavorites();
    }
    if (status === "unauthenticated") {
        router.push("/login");
    }
  }, [status, router]);

  const handleSlotChange = (index: number, value: string) => {
    const newSlots = [...slots];
    newSlots[index] = value;
    setSlots(newSlots);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError("");
    setSuccess("");

    const result = await updateFavorites(slots);

    if (result.success) {
      setSuccess("ãŠæ°—ã«å…¥ã‚Šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    } else {
      setError(result.error || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
    setIsLoading(false);
  };

  if (status === "loading" || isFetching) {
    return <div className="text-center p-10">èª­ã¿è¾¼ã¿ä¸­...</div>;
  }
  
  if (status === "unauthenticated") {
    return null;
  }

  return (
    <div className="container mx-auto p-4 sm:p-6 lg:p-8">
      <h1 className="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">ãŠæ°—ã«å…¥ã‚Šã‚¹ãƒ­ãƒƒãƒˆè¨­å®š</h1>
      <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md">
        {error && <p className="mb-4 text-red-500">{error}</p>}
        {success && <p className="mb-4 text-green-500">{success}</p>}

        <p className="text-gray-600 mb-6">
          ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹ã€è‡ªåˆ†ã‚„ä»–ã®äººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®šã—ã¾ã™ã€‚ï¼ˆæœ€å¤§5ä»¶ï¼‰
        </p>

        <div className="space-y-4">
          {slots.map((url, index) => (
            <div key={index}>
              <label htmlFor={`slot-${index}`} className="block text-sm font-medium text-gray-700">
                ã‚¹ãƒ­ãƒƒãƒˆ {index + 1}
              </label>
              <input
                type="text"
                id={`slot-${index}`}
                value={url}
                onChange={(e) => handleSlotChange(index, e.target.value)}
                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                placeholder="https://... or username"
              />
            </div>
          ))}
        </div>

        <div className="mt-6">
          <button type="submit" disabled={isLoading} className="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
            {isLoading ? "ä¿å­˜ä¸­..." : "ä¿å­˜ã™ã‚‹"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="src/app/dashboard/profile/page.tsx">
// src/app/dashboard/profile/page.tsx (æœ€çµ‚ãƒ»å®Œæˆç‰ˆ)

"use client";

import { useState, useEffect } from "react";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";
import { updateProfile } from "@/actions/updateProfile";

export default function ProfilePage() {
  const { data: session, status, update } = useSession();
  const router = useRouter();

  const [name, setName] = useState("");
  const [title, setTitle] = useState("");
  const [bio, setBio] = useState("");
  const [website, setWebsite] = useState("");
  const [twitter, setTwitter] = useState("");
  const [instagram, setInstagram] = useState("");
  const [image, setImage] = useState<string | null>(null);

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  useEffect(() => {
    if (status === "unauthenticated") {
      router.push("/login");
      return;
    }
    if (status === "authenticated") {
      const user = session.user as any;
      setName(user.name || "");
      setTitle(user.title || "");
      setBio(user.bio || "");
      setWebsite(user.website || "");
      setTwitter(user.twitter || "");
      setInstagram(user.instagram || "");
      setImage(user.image || "");
    }
  }, [status, session, router]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError("");
    setSuccess("");

    const imageData = image === "" ? null : image;
    const profileData = { name, title, bio, website, twitter, instagram, image: imageData };
    
    const result = await updateProfile(profileData);

    if (result.success) {
      setSuccess("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼");
      await update();
      router.refresh();
    } else {
      setError(result.error || "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
    setIsLoading(false);
  };

  if (status === "loading") {
    return <div className="text-center p-10">èª­ã¿è¾¼ã¿ä¸­...</div>;
  }

  if (status === "authenticated") {
    return (
      <div className="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 className="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h1>
        <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md">
          {error && <p className="mb-4 text-red-500">{error}</p>}
          {success && <p className="mb-4 text-green-500">{success}</p>}
          <div className="space-y-4">
            <div>
              <label htmlFor="image" className="block text-sm font-medium" style={{ color: '#374151' }}>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸURL</label>
              <div className="mt-2 flex items-center gap-x-3">
                 {image ? (
                  <img src={image} alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" className="h-24 w-24 rounded-full object-cover" />
                ) : (
                  <div className="h-24 w-24 bg-gray-200 rounded-full" />
                )}
              </div>
              <input type="url" id="image" value={image || ''} onChange={(e) => setImage(e.target.value)} className="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://..." />
              <p className="text-xs text-gray-500 mt-1">å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ç”»åƒã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div>
              <label htmlFor="name" className="block text-sm font-medium" style={{ color: '#374151' }}>åå‰</label>
              <input type="text" id="name" value={name} onChange={(e) => setName(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
            </div>
            <div>
              <label htmlFor="title" className="block text-sm font-medium" style={{ color: '#374151' }}>å½¹è·ãƒ»è‚©æ›¸ã</label>
              <input type="text" id="title" value={title} onChange={(e) => setTitle(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" />
            </div>
            <div>
              <label htmlFor="bio" className="block text-sm font-medium" style={{ color: '#374151' }}>è‡ªå·±ç´¹ä»‹</label>
              <textarea id="bio" value={bio} onChange={(e) => setBio(e.target.value)} rows={4} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
            </div>
            <div>
              <label htmlFor="website" className="block text-sm font-medium" style={{ color: '#374151' }}>ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
              <input type="url" id="website" value={website} onChange={(e) => setWebsite(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://..." />
            </div>
            <div>
              <label htmlFor="twitter" className="block text-sm font-medium" style={{ color: '#374151' }}>Twitter</label>
              <input type="url" id="twitter" value={twitter} onChange={(e) => setTwitter(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://twitter.com/..." />
            </div>
            <div>
              <label htmlFor="instagram" className="block text-sm font-medium" style={{ color: '#374151' }}>Instagram</label>
              <input type="url" id="instagram" value={instagram} onChange={(e) => setInstagram(e.target.value)} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://instagram.com/..." />
            </div>
          </div>
          <div className="mt-6">
            <button type="submit" disabled={isLoading} className="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
              {isLoading ? "ä¿å­˜ä¸­..." : "ä¿å­˜ã™ã‚‹"}
            </button>
          </div>
        </form>
      </div>
    );
  }

  return <div className="text-center p-10">èª­ã¿è¾¼ã¿ä¸­...</div>;
}
</file>

<file path="src/app/dashboard/settings/page.tsx">
"use client";

import { useState } from "react"; // useEffectã¯ä¸è¦ã«
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";
import { unlinkNfcCard } from "@/actions/unlinkNfcCard"; // ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

export default function SettingsPage() {
  const { data: session, status, update } = useSession(); // update ã‚’è¿½åŠ 
  const router = useRouter();

  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');

  // NFCã‚«ãƒ¼ãƒ‰ã®ç´ä»˜ã‘ã‚’è§£é™¤ã™ã‚‹å‡¦ç†
  const handleUnlink = async () => {
    if (!confirm("æœ¬å½“ã«NFCã‚«ãƒ¼ãƒ‰ã¨ã®ç´ä»˜ã‘ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      return;
    }
    setIsLoading(true);
    setMessage('');
    setError('');

    const result = await unlinkNfcCard();

    if (result.success) {
      setMessage("NFCã‚«ãƒ¼ãƒ‰ã®ç´ä»˜ã‘ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°ã—ã¦ã€ç”»é¢è¡¨ç¤ºã‚’å³åº§ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
      await update();
    } else {
      setError(result.error || "è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
    setIsLoading(false);
  };

  if (status === "loading") {
    return <div className="text-center p-10">èª­ã¿è¾¼ã¿ä¸­...</div>;
  }
  if (status === "unauthenticated") {
    router.push("/login");
    return null;
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‹ã‚‰nfcCardIdã‚’å–å¾—
  const nfcCardId = (session?.user as any)?.nfcCardId;

  return (
    <div className="container mx-auto p-4 sm:p-6 lg:p-8">
      <h1 className="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h1>
      
      {message && <p className="mb-4 text-green-500">{message}</p>}
      {error && <p className="mb-4 text-red-500">{error}</p>}

      {/* NFCã‚«ãƒ¼ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
      <div className="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 className="text-xl font-bold mb-4 text-gray-700">NFCã‚«ãƒ¼ãƒ‰é€£æº</h2>
        <div className="border-t border-gray-200 pt-4">
          {nfcCardId ? (
            <>
              <p className="text-gray-600 mb-1">
                ç¾åœ¨ã€ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®NFCã‚«ãƒ¼ãƒ‰ãŒç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
              </p>
              <p className="text-gray-800 font-mono bg-gray-100 p-2 rounded mb-4">
                {nfcCardId}
              </p>
              <button
                onClick={handleUnlink}
                disabled={isLoading}
                className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:bg-gray-400"
              >
                {isLoading ? "è§£é™¤ä¸­..." : "NFCã‚«ãƒ¼ãƒ‰ã®ç´ä»˜ã‘ã‚’è§£é™¤ã™ã‚‹"}
              </button>
            </>
          ) : (
            <p className="text-gray-600">
              ç¾åœ¨ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹NFCã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
          )}
        </div>
      </div>

      {/* å°†æ¥ã®ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h2 className="text-xl font-bold mb-4 text-gray-700">ãã®ä»–</h2>
        <p className="text-gray-500">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãªã©ã®æ©Ÿèƒ½ã¯ã€ã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  );
}
</file>

<file path="src/app/dashboard/layout.tsx">
// src/app/dashboard/layout.tsx (ä¸€æ™‚çš„ãªãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ¼ãƒ‰)

import Link from "next/link";
// getServerSession ã¨ redirect ã‚’ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
// import { getServerSession } from "next-auth";
// import { authOptions } from "@/app/api/auth/[...nextauth]/route";
// import { redirect } from "next/navigation";

export default function DashboardLayout({
  children,
}: {
  // â–¼â–¼â–¼ ã“ã“ã‚’ React.ReactNode ã«ä¿®æ­£ã—ã¾ã—ãŸ â–¼â–¼â–¼
  children: React.ReactNode;
}) {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  // const session = await getServerSession(authOptions);
  // if (!session) {
  //   redirect("/login");
  // }

  return (
    <div className="flex min-h-screen bg-gray-100">
      <aside className="w-64 bg-gray-800 text-white p-4 flex flex-col">
        <div className="mb-8">
          <Link href="/dashboard" className="text-2xl font-bold text-white">
            My Dashboard
          </Link>
        </div>
        <nav className="flex-grow">
          <ul>
            <li className="mb-2">
              <Link href="/dashboard" className="block p-2 rounded hover:bg-gray-700">
                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
              </Link>
            </li>
            <li className="mb-2">
              <Link href="/dashboard/profile" className="block p-2 rounded hover:bg-gray-700">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
              </Link>
            </li>
            <li className="mb-2">
              <Link href="/dashboard/favorites" className="block p-2 rounded hover:bg-gray-700">
                ãŠæ°—ã«å…¥ã‚Šè¨­å®š
              </Link>
            </li>
            <li className="mb-2">
              <Link href="/dashboard/direct-link" className="block p-2 rounded hover:bg-gray-700">
                ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªãƒ³ã‚¯è¨­å®š
              </Link>
            </li>
            <li className="mb-2 border-t border-gray-700 mt-4 pt-4">
              <Link href="/dashboard/settings" className="block p-2 rounded hover:bg-gray-700">
                ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
              </Link>
            </li>
          </ul>
        </nav>
        <div>
           <p className="text-sm text-gray-400">&copy; 2025 nfc-platform</p>
        </div>
      </aside>
      <main className="flex-1 p-8">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="src/app/dashboard/page.tsx">
// src/app/dashboard/page.tsx (å…ƒã®ã‚³ãƒ¼ãƒ‰ã«æˆ»ã™)

import DashboardClient from "@/components/DashboardClient";

export default function DashboardPage() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-8 text-gray-800">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <DashboardClient />
    </div>
  );
}
</file>

<file path="src/app/login/page.tsx">
// src/app/login/page.tsx

"use client";

import { useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation'; // useSearchParams ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { signIn } from 'next-auth/react';
import Link from 'next/link';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const router = useRouter();
  const searchParams = useSearchParams(); // searchParams ã‚’å–å¾—
  const cardId = searchParams.get('cardId'); // URLã‹ã‚‰ cardId ã‚’å–å¾—

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    try {
      const result = await signIn('credentials', {
        redirect: false,
        email,
        password,
      });

      if (result?.ok) {
        // â˜…â˜…â˜… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã®ç´ä»˜ã‘å‡¦ç†ã¯ã€æ¬¡ã®ã‚¿ã‚¹ã‚¯ã§ã“ã“ã«è¿½åŠ ã—ã¾ã™ â˜…â˜…â˜…
        router.push('/dashboard');
      } else {
        setError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
      }
    } catch (err) {
      setError('äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="p-8 bg-white rounded-lg shadow-md w-full max-w-md">
        <h2 className="text-2xl font-bold mb-6 text-center">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        {/* â–¼â–¼â–¼ cardId ãŒã‚ã‚‹å ´åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º â–¼â–¼â–¼ */}
        {cardId && (
          <div className="mb-4 p-3 bg-indigo-100 text-indigo-700 rounded-md text-center">
            <p className="font-semibold">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦NFCã‚«ãƒ¼ãƒ‰ã‚’ç´ä»˜ã‘ã¾ã™</p>
            <p className="text-sm">ID: {cardId}</p>
          </div>
        )}
        {error && <p className="mb-4 text-red-500 text-center">{error}</p>}
        <form onSubmit={handleSubmit}>
          {/* ... (ãƒ•ã‚©ãƒ¼ãƒ ã®ä¸­èº«ã¯å¤‰æ›´ãªã—) ... */}
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required />
          </div>
          <div className="mb-6">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required />
          </div>
          <div className="flex items-center justify-between">
            <button type="submit" className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</button>
          </div>
          <div className="text-center mt-4">
            <Link href="/forgot-password">
              <span className="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã§ã™ã‹ï¼Ÿ
              </span>
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/app/register/page.tsx">
// src/app/register/page.tsx (æœ€çµ‚ç‰ˆ)

"use client";

import { useState } from 'react';
import { useRouter } from 'next/navigation';

export default function RegisterPage() {
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState(''); // usernameã®Stateã‚’è¿½åŠ 
  const [error, setError] = useState('');
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ç°¡å˜ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!email || !password || !username) {
      setError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™ã€‚');
      return;
    }
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      setError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯åŠè§’è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚');
      return;
    }

    try {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          email,
          password,
          username, // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«usernameã‚’è¿½åŠ 
        }),
      });

      if (res.ok) {
        router.push('/login');
      } else {
        const data = await res.json();
        if (res.status === 409) {
            if (data === "Username already taken") {
                setError('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            } else if (data === "Email already taken") {
                setError('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            }
        } else {
             setError(data.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      }
    } catch (err) {
      setError('äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="p-8 bg-white rounded-lg shadow-md w-full max-w-md">
        <h2 className="text-2xl font-bold mb-6 text-center">æ–°è¦ç™»éŒ²</h2>
        {error && <p className="mb-4 text-red-500 text-center">{error}</p>}
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="name">
              åå‰
            </label>
            <input
              id="name"
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
              ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            </label>
            <input
              id="username"
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              required
              pattern="^[a-zA-Z0-9_]+$"
              title="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯åŠè§’è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚"
            />
             <p className="text-xs text-gray-500 mt-1">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLã«ä½¿ã‚ã‚Œã¾ã™ (ä¾‹: app.com/{username})</p>
          </div>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              required
            />
          </div>
          <div className="mb-6">
            <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            </label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              required
            />
          </div>
          <div className="flex items-center justify-between">
            <button
              type="submit"
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full"
            >
              ç™»éŒ²ã™ã‚‹
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/components/DashboardClient.tsx">
// src/components/DashboardClient.tsx (æœ€çµ‚ãƒ»å®Œæˆç‰ˆ)

"use client";

import { useState, useEffect, useRef } from "react"; // useRef ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { useSession } from "next-auth/react";
import { useSearchParams, useRouter } from 'next/navigation';
import Link from "next/link";
import { getProfileViewCount } from "@/actions/trackView";
import { linkNfcCard } from "@/actions/linkNfcCard";

interface FavoriteProfile {
  username: string | null;
  name: string | null;
  image: string | null;
}

export default function DashboardClient() {
  const { data: session, status, update } = useSession();
  const searchParams = useSearchParams();
  const router = useRouter();
  // â˜…â–¼â–¼â–¼ ref ã‚’è¿½åŠ  â–¼â–¼â–¼
  const hasLinkedRef = useRef(false); // ç´ä»˜ã‘å‡¦ç†ãŒæ—¢ã«å®Ÿè¡Œã•ã‚ŒãŸã‹è¿½è·¡ã™ã‚‹ãŸã‚ã®ref

  const [favoriteSlots, setFavoriteSlots] = useState<string[]>([]);
  const [favoriteProfiles, setFavoriteProfiles] = useState<FavoriteProfile[]>([]);
  const [isLoadingFavorites, setIsLoadingFavorites] = useState(true);
  const [viewCount, setViewCount] = useState(0);
  const [copySuccess, setCopySuccess] = useState('');

  useEffect(() => {
    // ãƒ­ã‚°ã‚’è¿½åŠ 
    console.log("ğŸŸ¢ DashboardClient useEffect ãŒç™ºç«ã—ã¾ã—ãŸã€‚");
    console.log("  - status:", status);
    console.log("  - session?.user?.id:", session?.user?.id);
    console.log("  - cardId param:", searchParams.get('cardId'));
    console.log("  - link param:", searchParams.get('link'));
    console.log("  - hasLinkedRef.current:", hasLinkedRef.current); // â–¼â–¼â–¼ è¿½åŠ 

    const fetchFavoritesData = async () => { /* ... */ };
    const fetchViewCount = async (userId: string) => { /* ... */ };

    const handleLinkCard = async () => {
      const cardId = searchParams.get('cardId');
      const shouldLink = searchParams.get('link');

      console.log("ğŸŸ¡ handleLinkCard å‘¼ã³å‡ºã—");

      // â˜…â–¼â–¼â–¼ ç´ä»˜ã‘å®Ÿè¡Œæ¡ä»¶ã‚’ã‚ˆã‚Šå³å¯†ã«ä¿®æ­£ â–¼â–¼â–¼
      // èªè¨¼æ¸ˆã¿ã€ã‹ã¤ã‚«ãƒ¼ãƒ‰IDã¨link=trueãŒURLã«ã‚ã‚Šã€ã‹ã¤ã¾ã ç´ä»˜ã‘å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å ´åˆ
      if (status === "authenticated" && session?.user?.id && cardId && shouldLink === 'true' && !hasLinkedRef.current) {
        hasLinkedRef.current = true; // å‡¦ç†å®Ÿè¡Œãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹

        console.log(`ğŸ”µ NFCã‚«ãƒ¼ãƒ‰ç´ä»˜ã‘é–‹å§‹: userId=${session.user.id}, cardId=${cardId}`);
        const result = await linkNfcCard(session.user.id, cardId);
        
        if (result.success) {
          alert('NFCã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ä»˜ã‘ã¾ã—ãŸï¼');
          await update();
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${result.error}`);
        }
        router.replace('/dashboard', { scroll: false }); // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      } else {
        console.log("âšª NFCã‚«ãƒ¼ãƒ‰ç´ä»˜ã‘ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶:");
        console.log(`  - status: ${status}`);
        console.log(`  - session?.user?.id: ${session?.user?.id}`);
        console.log(`  - cardId: ${cardId}`);
        console.log(`  - shouldLink: ${shouldLink}`);
        console.log(`  - hasLinkedRef.current: ${hasLinkedRef.current}`);
      }
    };
    
    // â–¼â–¼â–¼ useEffectå†…ã§ã®å‘¼ã³å‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    // èªè¨¼æ¸ˆã¿ã§ã€ã‹ã¤ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç¢ºå®šã—ãŸã‚‰ã€ç´ä»˜ã‘å‡¦ç†ã‚’è©¦ã¿ã‚‹
    if (status === "authenticated" && session?.user?.id) {
      fetchFavoritesData(); // ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
      fetchViewCount(session.user.id); // é–²è¦§æ•°ã‚‚å–å¾—
      handleLinkCard(); // ç´ä»˜ã‘å‡¦ç†ã‚’å®Ÿè¡Œ
    }
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

  }, [status, session, searchParams, router]); // ä¾å­˜é…åˆ—ã« session ã‚’è¿½åŠ ã—ã€router ã‚‚å«ã‚ã‚‹

  const profileUrl = status === "authenticated" ? `${window.location.origin}/${(session.user as any).username || ''}` : "";
  const copyUrlToClipboard = () => { /* ... */ };

  if (status === "loading") {
    return <p className="text-gray-800">èª­ã¿è¾¼ã¿ä¸­...</p>;
  }
  if (status === "unauthenticated" || !session?.user) {
    return <p className="text-red-500">ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>;
  }

  return (
    <div className="space-y-8">
      {/* ... (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¤‰æ›´ãªã—) ... */}
      <div className="bg-white p-6 rounded-lg shadow">
        <h3 className="text-lg font-bold mb-4 text-gray-800">ãŠæ°—ã«å…¥ã‚Šã‚¹ãƒ­ãƒƒãƒˆ</h3>
        {isLoadingFavorites ? (
          <p className="text-gray-500">ãŠæ°—ã«å…¥ã‚Šã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        ) : (
          <div className="flex space-x-4">
            {favoriteSlots.map((slot, index) => {
              const profile = favoriteProfiles.find(p => p.username === slot);
              return (
                <div key={index} className="flex-1 text-center">
                  {profile ? (
                    <Link href={`/${profile.username}`} className="block group">
                      {profile.image ? (
                        <img src={profile.image} alt={profile.name || ''} className="w-16 h-16 rounded-full mx-auto mb-2 object-cover group-hover:opacity-80 transition-opacity" />
                      ) : (
                        <div className="w-16 h-16 bg-gray-200 rounded-full mx-auto mb-2 group-hover:opacity-80 transition-opacity" />
                      )}
                      <p className="text-xs text-gray-600 truncate group-hover:text-blue-500">{profile.name}</p>
                    </Link>
                  ) : slot ? (
                    <a href={slot} target="_blank" rel="noopener noreferrer" className="block group">
                       <div className="w-16 h-16 bg-gray-200 rounded-full mx-auto mb-2 flex items-center justify-center group-hover:opacity-80 transition-opacity">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 text-gray-400">
                           <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                         </svg>
                       </div>
                       <p className="text-xs text-gray-600 truncate group-hover:text-blue-500">å¤–éƒ¨ãƒªãƒ³ã‚¯</p>
                    </a>
                  ) : (
                    <div className="w-16 h-16 bg-gray-100 border-2 border-dashed rounded-full mx-auto mb-2" />
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div className="md:col-span-1 space-y-8">
          <div className="bg-white p-6 rounded-lg shadow">
            <h3 className="text-lg font-bold mb-4 text-gray-800">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div className="flex flex-col items-center">
                {session.user.image ? (
                  <img src={session.user.image} alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" className="w-24 h-24 bg-gray-200 rounded-full mb-4 object-cover" />
                ) : (
                  <div className="w-24 h-24 bg-gray-200 rounded-full mb-4" />
                )}
                <p className="font-bold text-lg text-gray-800">{session.user.name || 'åå‰æœªè¨­å®š'}</p>
                <p className="text-sm text-gray-500">{(session.user as any).title || 'å½¹è·æœªè¨­å®š'}</p>
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h3 className="text-lg font-bold mb-4 text-gray-800">ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
            <p className="text-gray-800">é–²è¦§æ•°: {viewCount} å›</p>
          </div>
        </div>
        <div className="md:col-span-2 bg-white p-6 rounded-lg shadow">
          <h3 className="text-lg font-bold mb-4 text-gray-800">å…±æœ‰ãƒ„ãƒ¼ãƒ«</h3>
            <div className="flex flex-col md:flex-row items-center gap-8">
              <div className="text-center">
                  <div className="w-32 h-32 bg-gray-200 flex items-center justify-center">
                      <p className="text-xs text-gray-500">QRã‚³ãƒ¼ãƒ‰ (ä¸€æ™‚ç„¡åŠ¹)</p>
                  </div>
                  <p className="text-sm mt-2 text-gray-800">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«QRã‚³ãƒ¼ãƒ‰</p>
              </div>
              <div className="flex-1 w-full">
                  <label className="text-sm font-bold text-gray-800">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL</label>
                  <div className="flex items-center mt-2">
                      <input type="text" readOnly value={profileUrl} className="w-full p-2 border rounded-l-md bg-gray-100 text-gray-700" />
                      <button onClick={copyUrlToClipboard} className="bg-blue-500 text-white p-2 rounded-r-md hover:bg-blue-600 relative w-20">
                        {copySuccess ? 'OK!' : 'ã‚³ãƒ”ãƒ¼'}
                      </button>
                  </div>
              </div>
            </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/DirectLinkInterstitial.tsx">
// src/components/DirectLinkInterstitial.tsx

"use client";

import { useState, useEffect } from 'react';
import Link from 'next/link';

interface DirectLinkInterstitialProps {
  redirectUrl: string;
  profileUrl: string;
}

export default function DirectLinkInterstitial({ redirectUrl, profileUrl }: DirectLinkInterstitialProps) {
  const [countdown, setCountdown] = useState(3);

  useEffect(() => {
    const timer = setTimeout(() => {
      window.location.href = redirectUrl;
    }, 3000);

    const interval = setInterval(() => {
      setCountdown((prevCount) => {
        if (prevCount <= 1) {
          clearInterval(interval);
          return 0;
        }
        return prevCount - 1;
      });
    }, 1000);

    return () => {
      clearTimeout(timer);
      clearInterval(interval);
    };
  }, [redirectUrl]);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-white p-4">
      <div className="w-full max-w-md bg-gray-800 rounded-lg shadow-xl p-8 text-center">
        <div className="w-32 h-32 bg-gray-700 rounded-full mx-auto mb-6 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-16 h-16 text-gray-400">
           {/* â–¼â–¼â–¼ ã“ã®ä¸­ã® path d="..." ã®éƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¾ã—ãŸ â–¼â–¼â–¼ */}
           <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
          </svg>
        </div>
        <h1 className="text-2xl font-bold mb-4">ãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ã„ã¾ã™...</h1>
        
        <div className="space-y-4">
          <Link 
            href={`${profileUrl}?from=interstitial`}
            className="block w-full px-4 py-3 text-lg font-semibold text-center text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
          >
            ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã‚‹
          </Link>
        </div>

        <p className="text-gray-400 mt-6">
          {countdown > 0 ? `${countdown}ç§’å¾Œã«è‡ªå‹•ã§ç§»å‹•ã—ã¾ã™` : 'ç§»å‹•ä¸­...'}
        </p>

      </div>
    </div>
  );
}
</file>

<file path="src/components/VCardButton.tsx">
// src/components/VCardButton.tsx

"use client";

interface VCardButtonProps {
  user: {
    name: string | null;
    title: string | null;
    email: string | null;
    website: string | null;
  };
}

export default function VCardButton({ user }: VCardButtonProps) {
  const generateVCard = () => {
    const vCard = `BEGIN:VCARD
VERSION:3.0
N:${user.name || ''}
FN:${user.name || ''}
TITLE:${user.title || ''}
EMAIL:${user.email || ''}
URL:${user.website || ''}
END:VCARD`;

    const blob = new Blob([vCard], { type: "text/vcard;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${user.name || 'contact'}.vcf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return (
    <button
      onClick={generateVCard}
      className="inline-flex items-center px-4 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800"
    >
      é€£çµ¡å…ˆã‚’ä¿å­˜
    </button>
  );
}
</file>

<file path="src/hooks/useCurrentUser.ts">
// src/hooks/useCurrentUser.ts

import { useSession } from "next-auth/react";

export const useCurrentUser = () => {
  const session = useSession();
  return session.data?.user;
};
</file>

<file path="src/providers/AuthSessionProvider.tsx">
// src/providers/AuthSessionProvider.tsx

"use client";

import { SessionProvider } from "next-auth/react";

interface AuthSessionProviderProps {
  children: React.ReactNode;
}

export default function AuthSessionProvider({ children }: AuthSessionProviderProps) {
  return <SessionProvider>{children}</SessionProvider>;
}
</file>

<file path="src/types/user.ts">
// src/types/user.ts

export interface UserProfile {
  id: string;
  name: string | null;
  email: string | null;
  title: string | null;
  bio: string | null;
  website: string | null;
  twitter: string | null;
  instagram: string | null;
  image: string | null; // â–¼â–¼â–¼ ã“ã®è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
}
</file>

<file path="types/next-auth.d.ts">
// types/next-auth.d.ts (æœ€çµ‚ä¿®æ­£ç‰ˆ)

import { DefaultSession, DefaultUser } from "next-auth";

// Prismaã®Userãƒ¢ãƒ‡ãƒ«ã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã€NextAuthã®Userå‹ã‚’æ‹¡å¼µ
interface User extends DefaultUser {
  id: string;
  username: string | null;
  title: string | null;
  bio: string | null;
  website: string | null;
  twitter: string | null;
  instagram: string | null;
  image: string | null; // â–¼â–¼â–¼ ã“ã®è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
  nfcCardId: string | null; // â–¼â–¼â–¼ ã“ã®è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼

}

declare module "next-auth" {
  // Sessionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®userãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã€ä¸Šã§æ‹¡å¼µã—ãŸUserå‹ã§ä¸Šæ›¸ã
  interface Session {
    user: User;
  }
}

declare module "next-auth/jwt" {
  // JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚‚å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 
  interface JWT {
    id: string;
    username: string | null;
    image: string | null; // â–¼â–¼â–¼ ã“ã®è¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
  }
}
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 283 64"><path fill="black" d="M141 16c-11 0-19 7-19 18s9 18 20 18c7 0 13-3 16-7l-7-5c-2 3-6 4-9 4-5 0-9-3-10-7h28v-3c0-11-8-18-19-18zm-9 15c1-4 4-7 9-7s8 3 9 7h-18zm117-15c-11 0-19 7-19 18s9 18 20 18c6 0 12-3 16-7l-8-5c-2 3-5 4-8 4-5 0-9-3-11-7h28l1-3c0-11-8-18-19-18zm-10 15c2-4 5-7 10-7s8 3 9 7h-19zm-39 3c0 6 4 10 10 10 4 0 7-2 9-5l8 5c-3 5-9 8-17 8-11 0-19-7-19-18s8-18 19-18c8 0 14 3 17 8l-8 5c-2-3-5-5-9-5-6 0-10 4-10 10zm83-29v46h-9V5h9zM37 0l37 64H0L37 0zm92 5-27 48L74 5h10l18 30 17-30h10zm59 12v10l-3-1c-6 0-10 4-10 10v15h-9V17h9v9c0-5 6-9 13-9z"/></svg>
</file>

<file path="src/app/globals.css">
/* src/app/globals.css */

@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="src/app/layout.tsx">
// src/app/layout.tsx

import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

// ã“ã®è¡Œã‚’æ–°ã—ãè¿½åŠ ã—ã¾ã™
import AuthSessionProvider from "@/providers/AuthSessionProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {/* AuthSessionProviderã§childrenã‚’ãƒ©ãƒƒãƒ—ã—ã¾ã™ */}
        <AuthSessionProvider>
          {children}
        </AuthSessionProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/page.tsx">
// src/app/page.tsx (ä¿®æ­£ç‰ˆ)

"use client";

import { useSession, signOut } from "next-auth/react"; // useCurrentUserã®ä»£ã‚ã‚Šã«useSessionã‚’ç›´æ¥ä½¿ã†
import Link from "next/link";

export default function Home() {
  // sessionãƒ‡ãƒ¼ã‚¿ã¨ã€èª­ã¿è¾¼ã¿çŠ¶æ…‹(status)ã‚’å–å¾—
  const { data: session, status } = useSession();

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤º
  if (status === "loading") {
    return (
      <main className="flex min-h-screen flex-col items-center justify-center p-24">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
      </main>
    );
  }

  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24 bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-md text-center">
        <h1 className="text-3xl font-bold mb-4">
          ã‚ˆã†ã“ãï¼
        </h1>

        {/* ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ (statusãŒ'authenticated') */}
        {status === "authenticated" && session.user && (
          <div className="space-y-4">
            <p className="text-xl">
              ã“ã‚“ã«ã¡ã¯ã€<span className="font-semibold">{session.user.name || session.user.email}</span> ã•ã‚“
            </p>
            
            <div className="flex justify-center items-center gap-4">
              <Link href="/dashboard/profile" className="inline-block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã™ã‚‹
              </Link>
              
              <button
                onClick={() => signOut()} // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
                className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
              >
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        )}

        {/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆ (statusãŒ'unauthenticated') */}
        {status === "unauthenticated" && (
          <div className="space-y-4">
            <p className="text-xl">
              ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚
            </p>
            <div className="flex justify-center gap-4">
              <Link href="/login" className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                ãƒ­ã‚°ã‚¤ãƒ³
              </Link>
              <Link href="/register" className="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                æ–°è¦ç™»éŒ²
              </Link>
            </div>
          </div>
        )}
      </div>
    </main>
  );
}
</file>

<file path=".eslintrc.json">
{
  "extends": "next/core-web-vitals"
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js
.yarn/install-state.gz

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

/src/generated/prisma
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "nfc-platform",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@auth/prisma-adapter": "^2.11.1",
    "@prisma/client": "^6.19.0",
    "axios": "^1.13.2",
    "bcryptjs": "^3.0.3",
    "next": "14.2.5",
    "next-auth": "^4.24.13",
    "qrcode.react": "^4.2.0",
    "react": "^18",
    "react-dom": "^18"
  },
  "devDependencies": {
    "@types/axios": "^0.9.36",
    "@types/bcryptjs": "^2.4.6",
    "@types/node": "^20",
    "@types/qrcode.react": "^1.0.5",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "eslint": "^8",
    "eslint-config-next": "14.2.5",
    "postcss": "^8",
    "prisma": "^6.19.0",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic":
          "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

</files>
