generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Userモデル (Digital Hamsa拡張版)
model User {
  id                String    @id @default(cuid())
  username          String?   @unique
  name              String?
  email             String?   @unique
  emailVerified     DateTime?
  hashedPassword    String?
  image             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // プロフィール情報
  title             String?
  bio               String?   @db.Text
  website           String?
  twitter           String?
  instagram         String?
  
  // 機能設定
  nfcCardId         String?   @unique
  directLinkEnabled Boolean   @default(false)
  directLinkUrl     String?

  // --- [NEW] サロン・テーマ連携 ---
  // ユーザーが所属する（施術を受けた）サロン
  salonId           String?
  salon             Salon?    @relation(fields: [salonId], references: [id])

  // リレーション
  accounts          Account[]
  sessions          Session[]
  profileViews      ProfileView[]

  // 五大元素データ (Slot 0=火/親, 1=風/人, 2=空/中, 3=地/薬, 4=水/小)
  favorites         Favorite[] @relation("FavoriteOwner")
  favoritedBy       Favorite[] @relation("FavoriteSelectedUser")

  // フォロー機能
  followers         Follow[]   @relation("FollowerRelation")
  following         Follow[]   @relation("FollowingRelation")
}

// [NEW] Salonモデル (加盟店)
model Salon {
  id            String    @id @default(cuid())
  name          String    // サロン名 (例: "Cyber Nail Akishima")
  slug          String    @unique // URL用ID (例: cyber-nail)
  logoUrl       String?   // サロンロゴ画像のURL
  
  // ブランドカラー (Hamsaのベースカラー)
  primaryColor  String    @default("#000000") 
  accentColor   String    @default("#FFD700")

  // テーマ設定 (このサロンのネイルをした人のスマホ画面デザイン)
  themeId       String?
  theme         Theme?    @relation(fields: [themeId], references: [id])

  // 顧客リスト
  users         User[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// [NEW] Themeモデル (デザインプリセット)
model Theme {
  id            String    @id @default(cuid())
  name          String    // テーマ名 (例: "Mandala", "Cyber", "Zen")
  className     String    // CSSクラスや識別子 (Tailwindの設定などで使用)
  
  salons        Salon[]
}

// Favoriteモデル (五大元素スロットとして利用)
model Favorite {
  id             String    @id @default(cuid())
  ownerId        String    
  slotIndex      Int       // 0:親指(火), 1:人差(風), 2:中指(空), 3:薬指(地), 4:小指(水)
  selectedUserId String    
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  owner          User      @relation("FavoriteOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  selectedUser   User      @relation("FavoriteSelectedUser", fields: [selectedUserId], references: [id], onDelete: Restrict)

  @@unique([ownerId, slotIndex])
  @@index([selectedUserId])
}

// --- 以下、既存のNextAuth用モデル ---

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String    @id @default(cuid())
  sessionToken String    @unique
  userId       String
  expires      DateTime
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model Follow {
  id            String    @id @default(cuid())
  followerId    String    
  followingId   String    
  createdAt     DateTime  @default(now())
  follower      User      @relation("FollowingRelation", fields: [followerId], references: [id], onDelete: Cascade)
  following     User      @relation("FollowerRelation", fields: [followingId], references: [id], onDelete: Cascade)
  @@unique([followerId, followingId])
  @@index([followingId])
}

model ProfileView {
  id             String    @id @default(cuid())
  profileOwnerId String
  viewedAt       DateTime  @default(now())
  viewerIp       String?
  profileOwner   User      @relation(fields: [profileOwnerId], references: [id], onDelete: Cascade)
  @@index([profileOwnerId])
}